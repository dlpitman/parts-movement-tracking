<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movement Logs - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <nav class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Movement Logs (Admin)</h1>
      <div>
        <a class="text-blue-600 hover:underline mr-4" href="/form.html">Form</a>
        <a class="text-blue-600 hover:underline" href="/jogs.html">Admin</a>
      </div>
    </nav>

    <div class="bg-white p-4 rounded shadow mb-4">
      <div class="flex gap-3 flex-wrap">
        <input id="search" type="search" placeholder="Search (part, etching, submitter, location)" class="p-2 border rounded flex-1" />
        <input id="fromDate" type="date" class="p-2 border rounded" />
        <input id="toDate" type="date" class="p-2 border rounded" />
        <button id="filterBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Filter</button>
        <a id="csvLink" class="px-3 py-2 bg-gray-200 text-gray-800 rounded" href="/api/partslog/csv">Download CSV</a>
      </div>
    </div>

    <div id="tableWrap" class="bg-white rounded shadow overflow-auto">
      <table id="logsTable" class="min-w-full text-left">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-2">Timestamp</th>
            <th class="p-2">Part Name</th>
            <th class="p-2">Etching</th>
            <th class="p-2">Current Move Date</th>
            <th class="p-2">Next Location</th>
            <th class="p-2">Submitted By</th>
            <th class="p-2">Department</th>
            <th class="p-2">Issues</th>
          </tr>
        </thead>
        <tbody id="logsBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = '/api';

    async function fetchLogs() {
      const res = await fetch(`${API_BASE}/partslog`);
      if (!res.ok) throw new Error('Failed to fetch logs');
      return res.json();
    }

    function renderRows(rows) {
      const tbody = document.getElementById('logsBody');
      tbody.innerHTML = '';
      if (!rows.length) {
        tbody.innerHTML = '<tr><td class="p-4" colspan="8">No records found.</td></tr>';
        return;
      }
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 align-top">${new Date(r._ts).toLocaleString()}</td>
          <td class="p-2 align-top">${escapeHtml(r.part_name)}</td>
          <td class="p-2 align-top">${escapeHtml(r.etching)}</td>
          <td class="p-2 align-top">${escapeHtml(r.current_move_date)}</td>
          <td class="p-2 align-top">${escapeHtml(r.next_location)}</td>
          <td class="p-2 align-top">${escapeHtml(r.submitted_by)}</td>
          <td class="p-2 align-top">${escapeHtml(r.dept)}</td>
          <td class="p-2 align-top">${escapeHtml(r.issues)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(unsafe) {
      return (unsafe||'')
        .toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function applyFilters(rows) {
      const q = (document.getElementById('search').value || '').toLowerCase().trim();
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      return rows.filter(r => {
        if (q) {
          const hay = `${r.part_name} ${r.etching} ${r.submitted_by} ${r.next_location} ${r.last_location} ${r.issues}`.toLowerCase();
          if (!hay.includes(q)) return false;
        }
        if (from) {
          const d = new Date(r._ts).toISOString().slice(0,10);
          if (d < from) return false;
        }
        if (to) {
          const d = new Date(r._ts).toISOString().slice(0,10);
          if (d > to) return false;
        }
        return true;
      });
    }

    let cached = [];

    async function loadAndRender() {
      try {
        const rows = await fetchLogs();
        cached = rows.sort((a,b) => b._ts - a._ts);
        renderRows(applyFilters(cached));
      } catch (err) {
        document.getElementById('logsBody').innerHTML = `<tr><td class="p-4" colspan="8">Error fetching logs: ${escapeHtml(err.message)}</td></tr>`;
      }
    }

    document.getElementById('filterBtn').addEventListener('click', () => renderRows(applyFilters(cached)));
    document.getElementById('search').addEventListener('input', () => renderRows(applyFilters(cached)));

    // initial load
    loadAndRender();
  </script>
</body>
</html>
